-- ============================================================
-- CHLOE-X FULL LOADER (Config + Position + Game Autoload)
-- ============================================================

-- ================================
-- SAFE UTILITIES
-- ================================
local function safe_print(...)
    if print then
        print(...)
    end
end

-- ================================
-- CONFIG & POSITION SETTINGS
-- ================================
local config_url = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/set/aku"
local save_dir = "/storage/emulated/0/Delta/Workspace/Chloe X/Config"
local save_file = save_dir .. "/Chloe_Fish_It_.json"

local back_config_url = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/set/aku"
local back_save_dir = "/storage/emulated/0/Delta/Workspace/Chloe X/Config"
local back_save_file = save_dir .. "/Chloe_UPD_Fish_It_.json"

-- Gunakan position dari luar jika ada, jika tidak pakai default "eso"
if position == nil or position == "" then
    position = "eso"
    safe_print("[Chloe-X] Position tidak didefinisikan, menggunakan default:", position)
else
    safe_print("[Chloe-X] Position dari luar:", position)
end

local position_url = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/loct/" .. position
local position_backup = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/loct/eso"
local position_dir = "/storage/emulated/0/Delta/Workspace/Chloe X/FishIt"
local position_file = position_dir .. "/Position.json"

-- ================================
-- GAME SCRIPT TABLE
-- ================================
local games = {
    [121864768012064] = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/chx/Chloe-X-main/Games/FishIt.lua",
    [123921593837160] = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/chx/Chloe-X-main/Games/Climb%20And%20Jump.lua",
    [108343567000516] = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/chx/Chloe-X-main/Games/Climb%20And%20Jump%20Lego.lua",
    [129827112113663] = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/chx/Chloe-X-main/Games/Prscpt.lua",
}

-- Flexible HTTP GET
local function http_get(url)
    -- 1) game:HttpGet()
    local ok1, res1 = pcall(function()
        return game:HttpGet(url)
    end)
    if ok1 and res1 then
        return res1
    end

    -- 2) HttpService:GetAsync()
    local okHttp, HttpService = pcall(function()
        return game:GetService("HttpService")
    end)
    if okHttp and HttpService then
        local ok2, res2 = pcall(function()
            return HttpService:GetAsync(url)
        end)
        if ok2 and res2 then
            return res2
        end
    end

    -- 3) Generic executor requests
    local req_functions = {
        function(u)
            if request then
                local r = request({Url = u, Method = "GET"})
                return r and r.Body
            end
        end,
        function(u)
            if syn and syn.request then
                local r = syn.request({Url = u, Method = "GET"})
                return r and r.Body
            end
        end,
        function(u)
            if http and http.request then
                local r = http.request({url = u})
                return r and (r.body or r.Body)
            end
        end,
        function(u)
            if http_request then
                local r = http_request({Url = u, Method = "GET"})
                return r and r.Body
            end
        end,
    }

    for _, fn in ipairs(req_functions) do
        local ok3, res3 = pcall(fn, url)
        if ok3 and res3 then
            return res3
        end
    end

    error("http_get: Tidak ada metode yang berhasil.")
end

-- Buat folder otomatis
local function ensure_dir(path)
    if isfolder and makefolder then
        if not isfolder(path) then
            pcall(makefolder, path)
        end
        return true
    end

    -- Fallback (simple)
    return true
end

-- Tulis file
local function write_file(path, content)
    if writefile then
        pcall(writefile, path, content)
        return true
    end

    local f = io.open(path, "w")
    if f then
        f:write(content)
        f:close()
        return true
    end

    return false
end

-- Download file (universal)
local function download_file(url, dir, file)
    safe_print("[Chloe-X] Download:", file)
    ensure_dir(dir)

    local data = http_get(url)
    if data and #data > 0 then
        write_file(file, data)
        safe_print("[Chloe-X] Saved:", file)
    else
        safe_print("[Chloe-X] ERROR: Empty file for", file)
    end
end

-- MAIN LOADER
local function main()
    safe_print("[Chloe-X] Starting Loader...")

    -- 1) Download Config
    download_file(config_url, save_dir, save_file)
    download_file(back_config_url, back_save_dir, back_save_file)

    -- 2) Download Position dengan validasi fallback
    local success, data = pcall(http_get, position_url)
    if not success or not data or #data == 0 then
        safe_print("[Chloe-X] Position URL gagal, menggunakan backup:", position_backup)
        download_file(position_backup, position_dir, position_file)
    else
        write_file(position_file, data)
        safe_print("[Chloe-X] Position file saved dari position_url.")
    end

    -- 3) Load Game Script
    local placeId = game.PlaceId
    local scriptURL = games[placeId]

    if not scriptURL then
        game.Players.LocalPlayer:Kick("Yo! This game ain't on the list.\nCheck Discord for whitelisted games, homie.")
        return
    end

    safe_print("[Chloe-X] Loading Game Script:", scriptURL)

    local body = http_get(scriptURL)
    if not body then
        safe_print("[Chloe-X] Failed to download main script.")
        return
    end

    local fn, err = loadstring(body)
    if not fn then
        safe_print("[Chloe-X] Script compile error:", err)
        return
    end

    pcall(fn)
    safe_print("[Chloe-X] Game Script Executed.")
end

pcall(main)
