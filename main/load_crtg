-- Script untuk Delta executor (versi final dengan folder auto-create)
local config_url = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/main/set/0206"
local save_dir = "/storage/emulated/0/Delta/Workspace/Chloe X/Config"
local save_file = save_dir .. "/Chloe_Fish_It_.json"
local main_script_url = "https://raw.githubusercontent.com/MajestySkie/Chloe-X/main/Main/ChloeX"

-- File baru: Position
local position_url = "https://raw.githubusercontent.com/nelayanbuntal/nelayan/refs/heads/main/loct/crtg"
local position_dir = "/storage/emulated/0/Delta/Workspace/Chloe X/FishIt"
local position_file = position_dir .. "/Position.json"

-- Safe print
local function safe_print(...)
    if type(print) == "function" then
        print(...)
    end
end

-- HTTP GET fleksibel
local function http_get(url)
    -- 1) game:HttpGet
    if type(game) == "table" and type(game.HttpGet) == "function" then
        local ok, res = pcall(function() return game:HttpGet(url) end)
        if ok and res and #res > 0 then return res end
    end

    -- 2) HttpService:GetAsync
    if type(game) == "table" and type(game.GetService) == "function" then
        local ok, HttpService = pcall(function() return game:GetService("HttpService") end)
        if ok and HttpService and type(HttpService.GetAsync) == "function" then
            local s, res = pcall(function() return HttpService:GetAsync(url) end)
            if s and res and #res > 0 then return res end
        end
    end

    -- 3) executor requests
    local request_fns = {
        function(u) if type(request) == "function" then local r = request({Url = u, Method = "GET"}); return r and r.Body end end,
        function(u) if type(syn) == "table" and type(syn.request) == "function" then local r = syn.request({Url = u, Method = "GET"}); return r and r.Body end end,
        function(u) if type(http) == "table" and type(http.request) == "function" then local r = http.request({url = u}); return r and (r.body or r.Body) end end,
        function(u) if type(http_request) == "function" then local r = http_request({Url = u, Method = "GET"}); return r and r.Body end end,
    }
    for _, fn in ipairs(request_fns) do
        local ok, res = pcall(fn, url)
        if ok and res and #res > 0 then return res end
    end

    -- 4) fallback io.popen curl
    local popen_ok, handle = pcall(function() return io.popen('curl -s "' .. url:gsub('"','\\"') .. '"') end)
    if popen_ok and handle then
        local body = handle:read("*a")
        handle:close()
        if body and #body > 0 then return body end
    end

    error("http_get: Tidak ada metode HTTP yang berhasil di environment ini.")
end

-- Pastikan folder ada (versi final, lebih aman)
local function ensure_dir(path)
    local success = true

    -- Gunakan isfolder/makefolder jika tersedia
    if type(isfolder) == "function" and type(makefolder) == "function" then
        local cur = ""
        for part in path:gmatch("[^/]+") do
            cur = (cur == "" and part) or (cur .. "/" .. part)
            if not isfolder(cur) then
                local ok, err = pcall(makefolder, cur)
                if not ok then
                    safe_print("[-] Gagal membuat folder:", cur, "Error:", err)
                    success = false
                end
            end
        end
        return success
    end

    -- Fallback step by step
    local parts = {}
    for part in path:gmatch("[^/]+") do table.insert(parts, part) end
    local cur = ""
    for _, part in ipairs(parts) do
        cur = (cur == "" and part) or (cur .. "/" .. part)
        local f = io.open(cur, "r")
        if not f then
            local ok, _ = pcall(function()
                os.execute('mkdir "' .. cur:gsub('"','\\"') .. '"')
            end)
            if not ok then
                safe_print("[-] Fallback gagal buat folder:", cur)
                success = false
            end
        else
            f:close()
        end
    end

    return success
end

-- Menulis file
local function write_file(path, content)
    if type(writefile) == "function" then
        local ok, err = pcall(function() writefile(path, content) end)
        if ok then return true end
    end
    local f, ferr = io.open(path, "w")
    if not f then return false, ferr end
    f:write(content)
    f:close()
    return true
end

-- Fungsi download file umum
local function download_file(url, dir, filename, label)
    safe_print("[Delta] Mulai mengunduh " .. label .. " dari", url)
    local ok, body_or_err = pcall(http_get, url)
    if not ok then
        safe_print("[-] Gagal download " .. label .. ":", body_or_err)
        return
    end
    local body = body_or_err
    if not body or #body == 0 then
        safe_print("[-] " .. label .. " kosong saat diunduh.")
        return
    end
    safe_print("[+] " .. label .. " diterima. Ukuran:", #body, "bytes")

    -- pastikan folder ada
    local dir_ok = pcall(ensure_dir, dir)
    if not dir_ok then
        safe_print("[-] Gagal membuat folder untuk " .. label .. ". File mungkin tidak tersimpan.")
    end

    -- tulis file
    local wrote, write_err = write_file(filename, body)
    if not wrote then
        safe_print("[-] Gagal menyimpan " .. label .. ":", filename, " Error:", write_err)
    else
        safe_print("[+] " .. label .. " tersimpan di:", filename)
    end
end

-- MAIN
local function main()
    -- 1. Download Config
    download_file(config_url, save_dir, save_file, "Config")

    -- 2. Download Position
    download_file(position_url, position_dir, position_file, "Position")

    -- 3. Download & Jalankan Main Script
    safe_print("[Delta] Mengambil main script dari:", main_script_url)
    local ok2, main_body_or_err = pcall(http_get, main_script_url)
    if not ok2 then
        safe_print("[-] Gagal mengunduh main script:", main_body_or_err)
        return
    end
    local main_body = main_body_or_err
    if not main_body or #main_body == 0 then
        safe_print("[-] Main script kosong.")
        return
    end

    safe_print("[Delta] Mengeksekusi main script...")
    local func, load_err
    if type(loadstring) == "function" then
        func, load_err = loadstring(main_body)
    else
        func, load_err = load(main_body)
    end
    if not func then
        safe_print("[-] Gagal compile main script:", load_err)
        return
    end

    local ok_exec, exec_err = pcall(func)
    if not ok_exec then
        safe_print("[-] Error saat menjalankan main script:", exec_err)
    else
        safe_print("[+] Main script berhasil dijalankan.")
    end
end

local ok, err = pcall(main)
if not ok then
    safe_print("[-] Script utama error:", err)
end
